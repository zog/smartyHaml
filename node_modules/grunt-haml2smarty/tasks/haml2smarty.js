'use strict';

module.exports = function(grunt) {
  var path = require('path');

  grunt.registerMultiTask('haml2smarty', 'Compile Haml to Smarty', function() {
    var options = this.options();
    var cb = this.async();
    var scope = this.options().scope;

    grunt.verbose.writeflags(options, 'Options');
    grunt.util.async.forEachSeries(this.files, function(f, next) {
      var args;
      args = [f.dest];

      var input = grunt.file.read(f.src);

      grunt.file.write(f.dest, '');
      var haml2smarty = grunt.util.spawn({
        cmd: path.resolve(__dirname + "/../scripts/" + scope + ".rb"),
        args: args
        }, function(error, result, code) {
          next(error);
        }
      );

      haml2smarty.stdin.write(new Buffer(input));
      haml2smarty.stdin.end();
      haml2smarty.stdout.pipe(process.stdout);
      haml2smarty.stderr.pipe(process.stderr);
    }, cb);
  });
};
