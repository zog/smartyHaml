#!/usr/bin/ruby

puts "POST"
path = ARGV.first
out = File.open(path, 'w')
res = []
a = STDIN.read
a.gsub! /\<\/foreach\>\n\s*\<foreachelse\>/, "{foreachelse}"
a.gsub! /\<foreach (\w+)='(\w+)'\>/ do
  "{foreach $#{$1} as $#{$2}}"
end
a.gsub! /\<for( \w+\=\'.+?\')( \w+\=\'.+?\')?\>/ do
  var = min = max = step = ''
  [$1, $2].compact.each do |sub|
    k, v = sub.split '='
    k.strip!
    v.strip!
    if k == "step"
      step = v[1..-2]
    else
      var = k
      min, max = v[2..-3].split('..')
    end
  end

  "{for $#{var}=#{min} to #{max}#{step.size > 0 ? " step #{step}" : ''}}"
end
a.gsub! "</for>", "{/for}"
a.gsub! "</foreach>", "{/foreach}"
a.gsub! "</foreachelse>", "{/foreach}"

out.write a
